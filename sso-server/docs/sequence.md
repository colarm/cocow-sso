# 认证流程时序图

## 用户登录流程

```
用户              浏览器              SSO Server              数据库              Redis
 |                 |                     |                      |                  |
 |--输入用户名密码--->|                     |                      |                  |
 |                 |----POST /login----->|                      |                  |
 |                 |                     |----查询用户---------->|                  |
 |                 |                     |<---返回用户数据-------|                  |
 |                 |                     |                      |                  |
 |                 |                     |---验证密码 (Argon2)   |                  |
 |                 |                     |                      |                  |
 |                 |                     |---生成 JWT (Ed25519)  |                  |
 |                 |                     |                      |                  |
 |                 |                     |---存储 Session--------|----------------->|
 |                 |<---返回 Token-------|                      |                  |
 |<--登录成功-------|                     |                      |                  |
```

## OAuth2 授权码流程

```
客户端应用          用户浏览器            SSO Server            资源服务器
   |                 |                     |                      |
   |--跳转授权页面--->|                     |                      |
   |                 |----授权请求--------->|                      |
   |                 |<---登录页面---------|                      |
   |                 |----输入凭证--------->|                      |
   |                 |<---授权码 (code)----|                      |
   |<--回调+code-----|                     |                      |
   |----换取 Token------------------------>|                      |
   |<---Access Token-----------------------|                      |
   |----请求资源-------------------------------------------->|
   |<---返回资源--------------------------------------------|
```

## Token 刷新流程

```
客户端                      SSO Server                    Redis
  |                            |                            |
  |---POST /token------------->|                            |
  |   (refresh_token)          |---验证 Refresh Token------>|
  |                            |<--Token 有效---------------|
  |                            |---生成新 Access Token      |
  |                            |---轮换 Refresh Token       |
  |                            |---存储新 Token------------>|
  |<--新 Token-----------------|                            |
```

---

**安全要点**

- 密码使用 **Argon2id** 哈希存储
- JWT 使用 **Ed25519** 签名
- Refresh Token **单次使用 + 自动轮换**
- 所有通信强制 **TLS 1.3**
- Cookie 设置 **HttpOnly + Secure + SameSite=Strict**
